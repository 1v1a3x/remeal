<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Control panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <style>
        :root {
            --padding: 1vh;
            --header-height: 6vh;
            --notes-height: 30vh;
            --frame-height: 30vh;
            --buttons-height: calc(100vh - var(--notes-height) - var(--header-height) - var(--frame-height));
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-size: 16px;
            font-family: -apple-system, sans-serif;
            padding: 0;
            margin: 0;
        }

        header {
            position: relative;
            height: var(--header-height);
            border-bottom: 2px solid #000;
            display: flex;
        }

        h1 {
            font-size: 1em;
        }

        .title, .count, .timer {
            line-height: calc(var(--header-height) - var(--padding) * 2);
            margin: 0;
            padding: var(--padding);
        }

        .connected {
            position: absolute;
            top: calc((var(--header-height) - var(--padding)) / 2);
            right: calc((var(--header-height) - var(--padding)) / 2);
            height: var(--padding);
            width: var(--padding);

            border-radius: 50%;
            background-color: #f00;
        }

        .connected.ok {
            background-color: #0f0;
        }

        .notes {
            height: var(--notes-height);
            border-bottom: 1px solid #000;
            padding: var(--padding);
            overflow: scroll;
        }

        .frame {
            height: var(--frame-height);
        }

        .controls {
            height: var(--buttons-height);
            display: flex;
            align-content: stretch;
            align-items: stretch;
        }

        .column.left {
            width: 30%;
        }

        .column.right {
            width: 70%;
        }

        .button {
            text-align: center;
            border: 1px solid #000;
            font-size: 5vh;
        }

        .button.prev, .button.pause, .button.overview {
            --height: calc(var(--buttons-height) / 3);
            height: var(--height);
            line-height: var(--height);
        }

        .button.next {
            height: var(--buttons-height);
            line-height: var(--buttons-height);
        }
    </style>
</head>
<body>
    <main class="app">
        <header>
            <h1 class="title" id="title">&hellip;</h1>
            <div class="count" id="count"></div>
            <div class="timer" id="timer">00:00</div>
            <span class="connected" id="connected"></span>
        </header>
        <div class="frame" id="frame"></div>
        <div class="notes" id="notes"></div>
        <div class="controls">
            <div class="column left">
                <div class="button prev" id="prev"><i class="material-icons">navigate_before</i></div>
                <div class="button pause" id="pause"><i class="material-icons">pause</i></div>
                <div class="button overview" id="overview"><i class="material-icons">view_module</i></div>
            </div>
            <div class="column right">
                <div class="button next" id="next"><i class="material-icons">navigate_next</i></div>
            </div>
        </div>
    </main>

    <script>
      const socket = io(document.location.href)
      let frame
      let timerId

      // DOM nodes
      // Header
      const heading = document.getElementById('title')
      const count = document.getElementById('count')
      const timer = document.getElementById('timer')
      const indicator = document.getElementById('connected')

      // Body
      const presentationFrame = document.getElementById('frame')
      const speakerNotes = document.getElementById('notes')

      // Controls
      const prevButton = document.getElementById('prev')
      const nextButton = document.getElementById('next')
      const pauseButton = document.getElementById('pause')
      const overviewButton = document.getElementById('overview')

      // HTML
      const playCode = '<i class="material-icons">play_arrow</i>'
      const pauseCode = '<i class="material-icons">pause</i>'

      const setUpIframe = (url) => {
        frame && frame.remove()
        frame = document.createElement('iframe')
        frame.setAttribute('border', '0')
        frame.setAttribute('height', presentationFrame.offsetHeight)
        frame.setAttribute('width', presentationFrame.offsetWidth)
        frame.setAttribute('src', url)

        presentationFrame.appendChild(frame)
      }

      const update = ({ title, notes, total, state }) => {
        const { indexh } = state
        speakerNotes.innerHTML = notes
        count.innerText = `${indexh + 1}/${total}`

        pauseButton.innerHTML = state.paused ? playCode : pauseCode

        frame && frame.contentWindow.postMessage( JSON.stringify({ method: 'setState', args: [state] }), '*' )
      }

      const prepend = (value) => {
        return value.toString().length < 2 ? `0${value}` : value
      }

      const startTimer = () => {
        clearInterval(timerId)
        const time = new Date()
        timer.innerHTML = '00:00'

        timerId = setInterval(() => {
          const seconds = Math.round((new Date() - time) / 1000)

          timer.innerHTML = `${prepend(Math.floor(seconds / 60))}:${prepend(seconds % 60)}`
        }, 1000)
      }

      const emit = (command) => socket.emit('remote', { command })

      socket.on('connect', () => emit('requestreconnect'))

      socket.on('init', ({ title, url, notes, total, state }) => {
        indicator.classList.add('ok')
        heading.innerText = title

        setUpIframe(url)
        update({ notes, total, state })
        startTimer()
      })

      socket.on('setstate', ({ notes, total, state }) => {
        update({ notes, total, state })
      })

      prevButton.addEventListener('click', () => emit('prev'))
      nextButton.addEventListener('click', () => emit('next'))
      pauseButton.addEventListener('click', () => emit('pause'))
      overviewButton.addEventListener('click', () => emit('overview'))
      timer.addEventListener('click', () => startTimer())
    </script>
</body>
</html>