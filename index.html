<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Control panel</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.0/socket.io.js"></script>

    <style>
        :root {
            --padding: 1vh;
            --header-height: 6vh;
            --notes-height: 30vh;
            --frame-height: 30vh;
            --buttons-height: calc(100vh - var(--notes-height) - var(--header-height) - var(--frame-height));
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-size: 16px;
            font-family: -apple-system, sans-serif;
            padding: 0;
            margin: 0;
        }
        header {
            position: relative;
            height: var(--header-height);
            border-bottom: 2px solid #000;
            display: flex;
        }

        h1 {
            font-size: 1em;
        }

        .title, .timer {
            line-height: calc(var(--header-height) - var(--padding) * 2);
            margin: 0;
            padding: var(--padding);
        }

        .connected {
            position: absolute;
            top: calc((var(--header-height) - var(--padding)) / 2);
            right: calc((var(--header-height) - var(--padding)) / 2);
            height: var(--padding);
            width: var(--padding);

            border-radius: 50%;
            background-color: #f00;
        }

        .connected.ok {
            background-color: #0f0;
        }

        .notes {
            height: var(--notes-height);
            border-bottom: 2px solid #000;
            padding: var(--padding);
            overflow: scroll;
        }

        .frame {
            height: var(--frame-height);
            border-bottom: 2px solid #000;
        }

        .buttons {
            height: var(--buttons-height);
            display: flex;
        }

        .button {
            height: 100%;
            width: 50%;
            line-height: var(--buttons-height);
            text-align: center;

            font-size: 5vh;
        }
    </style>
</head>
<body>
    <main class="app">
        <header>
            <h1 class="title" id="title">...</h1>
            <div class="timer" id="timer">00:00</div>
            <span class="connected" id="connected"></span>
        </header>
        <div class="frame" id="frame"></div>
        <div class="notes" id="notes"></div>
        <div class="buttons">
            <div class="button" id="prev">&larr;</div>
            <div class="button" id="next">&rarr;</div>
        </div>
    </main>

    <script>
      const socket = io(document.location.href)
      let frame
      let timerId

      // DOM nodes
      const indicator = document.getElementById('connected')
      const heading = document.getElementById('title')
      const speakerNotes = document.getElementById('notes')
      const prevButton = document.getElementById('prev')
      const nextButton = document.getElementById('next')
      const presentationFrame = document.getElementById('frame')
      const timer = document.getElementById('timer')

      const setUpIframe = (url) => {
        frame && frame.remove()
        frame = document.createElement('iframe')
        frame.setAttribute('height', presentationFrame.offsetHeight)
        frame.setAttribute('width', presentationFrame.offsetWidth)
        frame.setAttribute('src', url)

        presentationFrame.appendChild(frame)
      }

      const update = ({ title, notes, total, indices }) => {
        const { h, v, f } = indices
        speakerNotes.innerHTML = notes
        heading.innerText = `${title}: ${indices.h + 1}/${total}`

        frame && frame.contentWindow.postMessage( JSON.stringify({ method: 'slide', args: [h, v, f] }), '*' )
      }

      const prepend = (value) => {
        return value.toString().length < 2 ? `0${value}` : value
      }

      const startTimer = () => {
        clearInterval(timerId)
        const time = new Date()
        timer.innerText = '00:00'

        timerId = setInterval(() => {
          const seconds = Math.round((new Date() - time) / 1000)

          timer.innerText = `${prepend(Math.floor(seconds / 60))}:${prepend(seconds % 60)}`
        }, 1000)
      }

      socket.on('connect', () => {
        socket.emit('requestreconnect')
      })

      socket.on('connected', ({ title, url, notes, total, indices,  }) => {
        indicator.classList.add('ok')

        setUpIframe(url)
        update({ title, notes, total, indices })
        startTimer()
      })

      socket.on('slidechanged', ({ title, notes, total, indices }) => {
        update({ title, notes, total, indices })
      })

      prevButton.addEventListener('click', () => socket.emit('prev'))
      nextButton.addEventListener('click', () => socket.emit('next'))
      timer.addEventListener('click', () => startTimer())
    </script>
</body>
</html>